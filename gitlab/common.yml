
####### DOCKER IMAGES
.debian-image:
  image: blockstream/gdk-debian-ci@sha256:51898f21a046c332d44dd5a6604e2bb3d5297f080e0f350a318830f4067d56d3
  tags: [ ga ]

.android-image:
  image: blockstream/gdk-android-builder@sha256:c626f8398ad5da1f8b2428a32a5f587018d36cd992c992c60da39e755960ae0c
  tags: [ ga ]

.python-image:
  image: blockstream/gdk-python-builder@sha256:1b8eae81e95bdd6999ea9b6de84ce5cdba298d2faef52500c1539fe5fd9c3e25
  tags: [ ga ]

.ubuntu-image:
  image: blockstream/gdk-ubuntu-builder@sha256:b4cf2ca7162c18ef5a5f06b045df83c065109e1e71f9b873043cc7f1c400cfc1
  tags: [ ga ]

.fedora-image:
  image: blockstream/gdk-fedora-builder@sha256:ca5c475b08289723e1b6e3742cefb5358bfa48b04341452886e54ba89e9ea498
  tags: [ ga ]


.py_release:
  variables:
    INSTALL_PATH: "gdk-python"
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 day
    when: on_success
    paths:
    - wheelhouse


.gcloud-publish:
  image: blockstream/gcloud-docker-tf:1.1.7
  tags:
    - ga
  stage: publish
  variables:
    GCLOUD_URL: "gs://green-gdk-builds"
  before_script:
    - subfolder=$CI_PROJECT_NAME-$CI_COMMIT_SHA
    - if [[ ${CI_COMMIT_REF_NAME} == "master" ]]; then subfolder=gdk-master; fi
    - TMPF=$(mktemp) || exit 1
    - echo $GCLOUD_PUSH_KEY > $TMPF
    - export GOOGLE_APPLICATION_CREDENTIALS=$TMPF
    - gcloud auth activate-service-account --key-file=$TMPF
    - rm -f $TMPF



##### WARNING!!!!
    # $PREBUILT_SUBDIR is the folder for the DIY caching system we have in place in mac machines
    # BUILD_IDX is your life belt in case you messed the CI up during the prebuild phase and the PREBUILT_DIR folder
    # is left in an unconsistent state, just change the BUILD_IDX and you are good to go.
    # when merged, go through all mac machines to delete old version of cache and reclaim some storage space
.osx_env:
  variables:
    BUILD_IDX: "1"
  before_script:
    - idx=($(shasum tools/* cmake/profiles/* | shasum))
    - export PREBUILT_SUBDIR="prebuilt-${idx}-${BUILD_IDX}"
